<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/eye.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post - Alexander Honkala</title>
    <meta name="description" content="A post by Alexander Honkala." />
    <meta property="og:title" content="Post - Alexander Honkala" />
    <meta property="og:description" content="A post by Alexander Honkala." />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://alexanderhonkala.com/post.html" />
    <meta property="og:image" content="https://alexanderhonkala.com/eye.svg" />
    <meta name="twitter:card" content="summary" />
    <link rel="alternate" type="application/rss+xml" title="Alexander Honkala" href="/feed.xml" />
    <link rel="stylesheet" href="/src/style.css">
</head>

<body class="content-page">
    <div class="post-layout">
        <canvas id="rule110-canvas" class="rule110-sidebar"></canvas>
        <div class="container">
            <header>
                <a href="thinking.html" class="back-link">‚Üê Back to Thinking</a>
                <h1 id="post-title">Loading...</h1>
                <div id="post-tags" class="post-tags"></div>
            </header>
            <main id="post-content" class="post-content">
                <!-- Content will be injected here -->
            </main>
        </div>
    </div>
    <script type="module">
        import { marked } from 'marked';
        import { initRule110 } from '/src/rule110.js';

        marked.setOptions({
            breaks: false,
            gfm: true
        });

        const params = new URLSearchParams(window.location.search);
        const slug = params.get('slug');

        if (!slug) {
            document.getElementById('post-title').innerText = 'Post Not Found';
            document.getElementById('post-content').innerHTML = '<p>No post specified.</p>';
        } else {
            // Fetch post content and index.json in parallel
            Promise.all([
                fetch(`/posts/${slug}.md`).then(r => {
                    if (!r.ok) throw new Error('Post not found');
                    return r.text();
                }),
                fetch('/posts/index.json').then(r => r.json()).catch(() => [])
            ]).then(([markdown, posts]) => {
                const html = marked.parse(markdown);
                document.getElementById('post-content').innerHTML = html;

                // Extract title from H1
                const h1 = document.querySelector('#post-content h1');
                if (h1) {
                    document.getElementById('post-title').innerText = h1.innerText;
                    h1.style.display = 'none';
                    document.title = `${h1.innerText} - Alexander Honkala`;
                    // Update OG tags dynamically
                    const ogTitle = document.querySelector('meta[property="og:title"]');
                    const ogDesc = document.querySelector('meta[property="og:description"]');
                    if (ogTitle) ogTitle.content = `${h1.innerText} - Alexander Honkala`;
                } else {
                    document.getElementById('post-title').innerText = 'Untitled Post';
                }

                // Render tags
                const postData = posts.find(p => p.slug === slug);
                if (postData && postData.tags && postData.tags.length > 0) {
                    const tagsContainer = document.getElementById('post-tags');
                    tagsContainer.innerHTML = postData.tags.map(tag =>
                        `<a href="thinking.html?tag=${encodeURIComponent(tag)}" class="tag-label">${tag}</a>`
                    ).join('');

                    // Update OG description with post description
                    const ogDesc = document.querySelector('meta[property="og:description"]');
                    if (ogDesc && postData.description) ogDesc.content = postData.description;
                }

                // Initialize Rule 110 sidebar after content renders
                initRule110('rule110-canvas');
            }).catch(err => {
                console.error(err);
                document.getElementById('post-title').innerText = 'Error';
                document.getElementById('post-content').innerHTML = '<p>Could not load post. It might not exist.</p>';
            });
        }
    </script>
    <script type="module" src="/src/night-mode.js"></script>
</body>

</html>
